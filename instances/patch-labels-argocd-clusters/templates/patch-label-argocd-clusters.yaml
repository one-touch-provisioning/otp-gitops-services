---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: patch-secret-{{ .Values.clusterName | lower }}
  namespace: openshift-gitops
spec:
  schedule: "* * * * *"
  jobTemplate:
    spec:
      serviceAccountName: openshift-gitops-otp-argocd-application-controller
      template:
        spec:
          containers:
          - name: patch-secret-{{ .Values.clusterName | lower }}
            image: quay.io/openshift/origin-cli:v3.11
            command: ["/bin/bash"]
            args:
            - -c
            - |-
              export platform=$(oc get clusterdeployments.hive.openshift.io {{ .Values.clusterName }} -n {{ .Values.clusterName }} -o=jsonpath='{.metadata.labels.hive\.openshift\.io/cluster-platform}')
              export majorVersion=$(oc get clusterdeployments.hive.openshift.io {{ .Values.clusterName }} -n {{ .Values.clusterName }} -o=jsonpath='{.metadata.labels.hive\.openshift\.io/version-major}')
              export majorMinorVersion=$(oc get clusterdeployments.hive.openshift.io {{ .Values.clusterName }} -n {{ .Values.clusterName }}oc -o=jsonpath='{.metadata.labels.hive\.openshift\.io/version-major-minor}')
              oc patch secret {{ .Values.clusterName }}-cluster-secret -n openshift-gitops --type json -p '[{"op": "add", "path": "/metadata/labels/hive.openshift.io~1cluster-platform", "value": "$platform"}]'
              oc patch secret {{ .Values.clusterName }}-cluster-secret -n openshift-gitops --type json -p '[{"op": "add", "path": "/metadata/labels/hive.openshift.io~1version-major", "value": "$majorVersion"}]'
              oc patch secret {{ .Values.clusterName }}-cluster-secret -n openshift-gitops --type json -p '[{"op": "add", "path": "/metadata/labels/hive.openshift.io~1version-major-minor", "value": "$majorMinorVersion"}]'
          restartPolicy: OnFailure